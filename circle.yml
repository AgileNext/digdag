machine:
  timezone: UTC
  java:
    version: oraclejdk8
  environment:
    TERM: dumb  # don't let gradle use fancy ansi seq code

dependencies:
  override:
    - ./gradlew -v
    - ./gradlew testClasses  # download and cache dependencies in circleci

test:
  override:
    - ./gradlew clean test --info
    - |
      DIGDAG_TEST_POSTGRESQL="
        host = localhost
        port = 5432
        user = ubuntu
        password =
        database = circle_test
      " ./gradlew check --info --rerun-tasks
  post:
    - mkdir -p $CIRCLE_ARTIFACTS/reports
    - |
      for dir in digdag-*/build/reports; do
        cp -a $dir $CIRCLE_ARTIFACTS/reports/${dir%%/*}
      done

